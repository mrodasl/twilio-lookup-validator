<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de N√∫meros - Twilio Lookup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            text-align: center;
            font-size: 14px;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }
        
        .count {
            text-align: right;
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        
        button {
            background: #F22F46;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            font-weight: bold;
        }
        
        button:hover {
            background: #d41e33;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results {
            margin-top: 30px;
        }
        
        .result-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }
        
        .result-item.active {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }
        
        .result-item.inactive {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .result-item.error {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        
        .number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status {
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .summary span {
            margin-right: 15px;
        }
        
        .note {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 12px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Validador de N√∫meros Telef√≥nicos</h1>
        <div class="subtitle">Usando Twilio Lookup API - Verifica si un n√∫mero est√° activo</div>
        
        <div class="input-section">
            <label>Ingresa los n√∫meros a validar (uno por l√≠nea):</label>
            <textarea id="numbersInput" placeholder="Ejemplo:
+502 5555-5555
+1 234 567 8900
+52 55 1234 5678"></textarea>
            <div class="count" id="numberCount">0 n√∫meros listos</div>
        </div>
        
        <button id="validateBtn" onclick="validateNumbers()">Validar N√∫meros</button>
        
        <div class="note">
            ‚ìò Twilio Lookup hace un ping al operador para verificar si el n√∫mero existe y est√° activo. 
            No se env√≠a ning√∫n SMS. M√°ximo 50 n√∫meros por lote.
        </div>
        
        <div class="results" id="resultsContainer">
            <div id="resultsList"></div>
            <div id="loading" class="loading hidden">
                Validando n√∫meros... <div id="progress">0%</div>
            </div>
            <div id="summary" class="summary hidden">
                <span>Total: <strong id="totalCount">0</strong></span>
                <span>Activos: <strong id="activeCount">0</strong></span>
                <span>Inactivos: <strong id="inactiveCount">0</strong></span>
                <span>Errores: <strong id="errorCount">0</strong></span>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const CONFIG = {
            maxNumbers: 50,
            apiEndpoint: '/.netlify/functions/lookup'
        };

        // Estado
        let isProcessing = false;
        let results = [];

        // Contador de n√∫meros en tiempo real
        document.getElementById('numbersInput').addEventListener('input', function() {
            const numbers = parseNumbers(this.value);
            const count = numbers.length;
            const countElement = document.getElementById('numberCount');
            
            countElement.textContent = `${count} n√∫meros listos`;
            
            if (count > CONFIG.maxNumbers) {
                countElement.style.color = '#f44336';
                countElement.textContent += ` (M√°ximo: ${CONFIG.maxNumbers})`;
            } else {
                countElement.style.color = '#666';
            }
        });

        // Funci√≥n para parsear n√∫meros
        function parseNumbers(input) {
            return input.split('\n')
                .map(num => num.trim())
                .filter(num => num.length > 0)
                .map(num => {
                    // Limpiar formato: eliminar espacios, guiones, par√©ntesis
                    return num.replace(/\s+/g, '')
                              .replace(/[()\-]/g, '');
                })
                .slice(0, CONFIG.maxNumbers);
        }

        // Funci√≥n principal de validaci√≥n
        async function validateNumbers() {
            if (isProcessing) {
                alert('Ya hay una validaci√≥n en proceso');
                return;
            }
            
            const input = document.getElementById('numbersInput').value;
            let numbers = parseNumbers(input);
            
            if (numbers.length === 0) {
                alert('Por favor ingresa al menos un n√∫mero telef√≥nico');
                return;
            }
            
            if (numbers.length > CONFIG.maxNumbers) {
                alert(`M√°ximo ${CONFIG.maxNumbers} n√∫meros por lote`);
                return;
            }
            
            // Verificar formato de n√∫meros
            numbers = numbers.map(num => {
                // Asegurar formato internacional
                if (!num.startsWith('+')) {
                    // Si empieza con 502, a√±adir +
                    if (num.startsWith('502')) {
                        return '+' + num;
                    }
                    // Si es un n√∫mero local guatemalteco (8 d√≠gitos)
                    if (num.length === 8 && !isNaN(num)) {
                        return '+502' + num;
                    }
                }
                return num;
            });
            
            console.log('N√∫meros a validar (formateados):', numbers);
            
            // Iniciar proceso
            isProcessing = true;
            results = [];
            
            const btn = document.getElementById('validateBtn');
            btn.disabled = true;
            btn.textContent = 'Validando...';
            
            // Mostrar loading
            const loading = document.getElementById('loading');
            const resultsList = document.getElementById('resultsList');
            loading.classList.remove('hidden');
            resultsList.innerHTML = '';
            
            // Ocultar resumen anterior
            document.getElementById('summary').classList.add('hidden');
            
            console.log(`Iniciando validaci√≥n de ${numbers.length} n√∫meros...`);
            
            // Procesar cada n√∫mero
            for (let i = 0; i < numbers.length; i++) {
                const number = numbers[i];
                
                // Actualizar progreso
                const progress = Math.round(((i + 1) / numbers.length) * 100);
                document.getElementById('progress').textContent = `${progress}% (${i + 1}/${numbers.length})`;
                
                // Mostrar en la lista como procesando
                showResultItem(number, 'processing', 'Validando...');
                
                try {
                    // Llamar a la funci√≥n de Netlify
                    const result = await lookupNumber(number);
                    
                    console.log(`Resultado para ${number}:`, result);
                    
                    // Actualizar resultado
                    updateResultItem(i, number, result);
                    
                    // Guardar en resultados
                    results.push({
                        number: number,
                        status: result.status,
                        carrier: result.carrier,
                        country: result.country,
                        error: result.error,
                        message: result.message,
                        timestamp: new Date().toISOString()
                    });
                    
                } catch (error) {
                    console.error(`Error con ${number}:`, error);
                    
                    updateResultItem(i, number, {
                        status: 'error',
                        error: error.message || 'Error de conexi√≥n',
                        message: 'Error en la solicitud'
                    });
                    
                    results.push({
                        number: number,
                        status: 'error',
                        error: error.message,
                        message: 'Error de conexi√≥n',
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Peque√±a pausa entre requests (para no exceder rate limits)
                if (i < numbers.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 segundo entre requests
                }
            }
            
            // Finalizar proceso
            isProcessing = false;
            btn.disabled = false;
            btn.textContent = 'Validar N√∫meros';
            loading.classList.add('hidden');
            
            // Mostrar resumen
            showSummary();
            
            console.log('Validaci√≥n completada:', results);
        }

        // Funci√≥n para mostrar √≠tem de resultado
        function showResultItem(number, status, message) {
            const resultsList = document.getElementById('resultsList');
            const item = document.createElement('div');
            item.className = `result-item ${status}`;
            item.id = `result-${resultsList.children.length}`;
            item.innerHTML = `
                <div class="number">${number}</div>
                <div class="status">${message}</div>
            `;
            resultsList.appendChild(item);
        }

        // Funci√≥n para actualizar √≠tem de resultado
        function updateResultItem(index, number, data) {
            const item = document.getElementById(`result-${index}`);
            if (!item) return;
            
            let statusClass = 'error';
            let statusText = data.message || 'Error desconocido';
            
            if (data.success === true) {
                if (data.status === 'active') {
                    statusClass = 'active';
                    statusText = `${data.message} | Operador: ${data.carrier || 'Desconocido'} | Pa√≠s: ${data.country || 'N/A'}`;
                } else if (data.status === 'inactive') {
                    statusClass = 'inactive';
                    statusText = `‚ùå INACTIVO | ${data.message || 'El n√∫mero no existe o est√° apagado'}`;
                } else if (data.status === 'invalid') {
                    statusClass = 'error';
                    statusText = `‚ùå INV√ÅLIDO | ${data.message || 'Formato incorrecto'}`;
                } else if (data.status === 'unknown') {
                    statusClass = 'error';
                    statusText = `‚ö†Ô∏è DESCONOCIDO | ${data.message || 'No se pudo determinar el estado'}`;
                }
            } else {
                statusClass = 'error';
                statusText = `‚ö†Ô∏è ERROR: ${data.error || data.details || 'Error en la validaci√≥n'}`;
                
                // Mensajes m√°s amigables para errores comunes
                if (data.code === 20003) {
                    statusText = 'üîê ERROR: Credenciales de Twilio incorrectas. Verifica las variables de entorno en Netlify.';
                } else if (data.code === 20001) {
                    statusText = 'üí∞ ERROR: Cuenta Twilio sin saldo o desactivada. Agrega fondos a tu cuenta.';
                } else if (data.code === 21211) {
                    statusText = 'üìû ERROR: Formato de n√∫mero incorrecto. Usa: +502XXXXXXXX';
                } else if (data.status === 'rate_limited') {
                    statusText = '‚è∞ ERROR: Demasiadas solicitudes. Espera unos minutos.';
                }
            }
            
            item.className = `result-item ${statusClass}`;
            item.innerHTML = `
                <div class="number">${number}</div>
                <div class="status">${statusText}</div>
            `;
        }

        // Funci√≥n para mostrar resumen
        function showSummary() {
            const active = results.filter(r => r.status === 'active').length;
            const inactive = results.filter(r => r.status === 'inactive').length;
            const invalid = results.filter(r => r.status === 'invalid').length;
            const errors = results.filter(r => r.status === 'error' || r.status === 'unknown').length;
            const total = results.length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('inactiveCount').textContent = inactive + invalid;
            document.getElementById('errorCount').textContent = errors;
            
            document.getElementById('summary').classList.remove('hidden');
        }

        // Funci√≥n para llamar a Lookup API
        async function lookupNumber(phoneNumber) {
            try {
                console.log(`Consultando Lookup API para: ${phoneNumber}`);
                
                const response = await fetch(CONFIG.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        number: phoneNumber
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Si hay error en la respuesta, lanzar excepci√≥n
                if (!result.success) {
                    throw new Error(result.error || result.details || 'Error en la validaci√≥n');
                }
                
                return result;
                
            } catch (error) {
                console.error('Error en lookupNumber:', error);
                return {
                    success: false,
                    status: 'error',
                    error: error.message,
                    details: error.toString()
                };
            }
        }

        // Manejo de Enter en el textarea
        document.getElementById('numbersInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                validateNumbers();
            }
        });
        
        // A√±adir clase hidden al CSS si no existe
        const style = document.createElement('style');
        style.textContent = '.hidden { display: none !important; }';
        document.head.appendChild(style);
    </script>
</body>
</html>
